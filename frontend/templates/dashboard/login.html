{% extends 'base.html' %}

{% block title %}Login - CryptAI{% endblock %}

{% block content %}
<style>
    /* Login page: plain theme background */
    body {
        background: linear-gradient(135deg, var(--primary-gradient-start, #113E80) 0%, var(--primary-gradient-end, #1a5bb8) 100%) !important;
        background-color: #113E80 !important;
        min-height: 100vh;
        color: var(--text-color);
    }
</style>

<!-- Login modal overlay (auto-opened) -->
<div class="login-modal-overlay show" id="login-modal-overlay" aria-hidden="false">
    <div class="login-modal-dialog card shadow" role="dialog" aria-labelledby="login-modal-title">
        <div class="card-header position-relative">
            <h5 class="mb-0" id="login-modal-title"><i class="fas fa-sign-in-alt me-2"></i>Login</h5>
            <button type="button" class="login-modal-close" id="login-modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="card-body">
            {% if error %}
            <div class="alert alert-danger" role="alert" id="login-modal-error">
                <i class="fas fa-exclamation-triangle"></i> {{ error }}
            </div>
            {% else %}
            <div id="login-modal-error" class="alert alert-danger d-none" role="alert"></div>
            {% endif %}
            
            {% if email_not_verified %}
            <div class="alert alert-warning" role="alert">
                <h6><i class="fas fa-envelope"></i> Email Verification Required</h6>
                <p class="mb-2">Your email address ({{ user_email }}) has not been verified yet.</p>
                <p class="mb-3">Please check your inbox for the verification email, or click below to resend it.</p>
                <form method="post" action="{% url 'subscription:resend_verification' %}" style="margin: 0;">
                    {% csrf_token %}
                    <input type="hidden" name="email" value="{{ user_email }}">
                    <button type="submit" class="btn btn-warning btn-sm">
                        <i class="fas fa-paper-plane"></i> Resend Verification Email
                    </button>
                </form>
                <hr class="my-3">
                <p class="mb-0">
                    <small>
                        <a href="{% url 'subscription:verification_pending' %}" class="text-decoration-none">
                            <i class="fas fa-info-circle"></i> Need help?
                        </a>
                    </small>
                </p>
            </div>
            {% endif %}
            
            <form id="login-modal-form" method="post">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <div class="mb-3">
                    <label for="login-username" class="form-label"><i class="fas fa-user me-1"></i>Username</label>
                    <input type="text" class="form-control" id="login-username" name="username" required autocomplete="username">
                </div>
                <div class="mb-3">
                    <label for="login-password" class="form-label"><i class="fas fa-lock me-1"></i>Password</label>
                    <input type="password" class="form-control" id="login-password" name="password" required autocomplete="current-password">
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary" id="login-modal-btn">
                        <i class="fas fa-sign-in-alt me-1"></i>Login
                    </button>
                </div>
            </form>
            <p class="text-center text-muted small mt-3 mb-0">
                <i class="fas fa-info-circle me-1"></i>Don't have an account? Contact your administrator.
            </p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var overlay = document.getElementById('login-modal-overlay');
    var closeBtn = document.getElementById('login-modal-close');
    var form = document.getElementById('login-modal-form');
    var errorEl = document.getElementById('login-modal-error');
    var submitBtn = document.getElementById('login-modal-btn');
    
    // Ensure modal is open
    if (overlay) overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    function closeLoginModal() {
        if (overlay) overlay.classList.remove('show');
        if (overlay) overlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        // Redirect to home if closing from /login/ page
        if (window.location.pathname === '/login/' || window.location.pathname.includes('/login')) {
            window.location.href = '{% url "dashboard:home" %}';
        }
    }
    
    if (closeBtn) closeBtn.addEventListener('click', closeLoginModal);
    if (overlay) overlay.addEventListener('click', function(e) {
        if (e.target === overlay) closeLoginModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && overlay && overlay.classList.contains('show')) closeLoginModal();
    });
    
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            var loginUrl = '{% url "dashboard:login" %}';
            var next = new URLSearchParams(window.location.search).get('next') || '/dashboard/';
            var formData = new FormData(form);
            formData.append('next', next);
            if (errorEl) { errorEl.classList.add('d-none'); errorEl.textContent = ''; }
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Logging in...';
            
            var csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
            var csrfToken = (csrfInput && csrfInput.value) || (document.querySelector('meta[name="csrf-token"]') && document.querySelector('meta[name="csrf-token"]').content) || '';
            var headers = {};
            if (csrfToken) headers['X-CSRFToken'] = csrfToken;
            fetch(loginUrl + '?next=' + encodeURIComponent(next), {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                redirect: 'manual',
                headers: headers
            }).then(function(res) {
                if (res.status === 302 || res.type === 'opaqueredirect') {
                    var loc = res.headers.get('Location');
                    if (loc) { window.location.href = loc; return; }
                }
                return res.text().then(function(html) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-sign-in-alt me-1"></i>Login';
                    if (res.ok) {
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(html, 'text/html');
                        var alert = doc.querySelector('.alert-danger, .alert-warning, .alert');
                        var msg = alert ? (alert.textContent || alert.innerText).trim() : 'Invalid username or password. Please try again.';
                        if (errorEl) {
                            errorEl.textContent = msg;
                            errorEl.classList.remove('d-none');
                        }
                    } else {
                        if (errorEl) {
                            errorEl.textContent = 'Unable to log in. Please try again.';
                            errorEl.classList.remove('d-none');
                        }
                    }
                });
            }).catch(function() {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt me-1"></i>Login';
                if (errorEl) {
                    errorEl.textContent = 'Network error. Please try again.';
                    errorEl.classList.remove('d-none');
                }
            });
        });
    }
});
</script>
{% endblock %}




