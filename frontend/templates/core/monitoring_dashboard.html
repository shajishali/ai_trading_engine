{% extends 'base.html' %}
{% load static %}

{% block title %}CryptAI - Monitoring Dashboard{% endblock %}

{% block extra_css %}
<style>
    .monitoring-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        color: white;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-healthy { background-color: #28a745; }
    .status-warning { background-color: #ffc107; }
    .status-unhealthy { background-color: #dc3545; }
    .status-unknown { background-color: #6c757d; }
    
    .metric-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .alert-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #dc3545;
    }
    
    .alert-critical {
        border-left-color: #dc3545;
        background-color: #fff5f5;
    }
    
    .alert-warning {
        border-left-color: #ffc107;
        background-color: #fffbf0;
    }
    
    .service-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .service-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .service-card:hover {
        transform: translateY(-2px);
    }
    
    .service-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .control-panel {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .btn-monitoring {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        margin-right: 10px;
        margin-bottom: 10px;
        transition: all 0.3s;
    }
    
    .btn-monitoring:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        color: white;
    }
    
    .btn-stop {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    
    .btn-start {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .performance-chart {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .uptime-display {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .uptime-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .refresh-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        z-index: 1000;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="monitoring-card">
                <h1 class="mb-0">
                    <i class="fas fa-chart-line me-3"></i>
                    CryptAI Monitoring Dashboard
                </h1>
                <p class="mb-0 mt-2">Phase 7B.3 - Comprehensive Monitoring & Alerting System</p>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="control-panel">
                <h4><i class="fas fa-cogs me-2"></i>Monitoring Control Panel</h4>
                <div class="d-flex flex-wrap">
                    <button class="btn btn-monitoring btn-start" onclick="startMonitoring()">
                        <i class="fas fa-play me-2"></i>Start Monitoring
                    </button>
                    <button class="btn btn-monitoring btn-stop" onclick="stopMonitoring()">
                        <i class="fas fa-stop me-2"></i>Stop Monitoring
                    </button>
                    <button class="btn btn-monitoring" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                    <button class="btn btn-monitoring" onclick="testAlert()">
                        <i class="fas fa-bell me-2"></i>Test Alert
                    </button>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Last updated: <span id="last-updated">Never</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <h4><i class="fas fa-heartbeat me-2"></i>System Status Overview</h4>
            <div class="service-grid" id="service-grid">
                <!-- Service cards will be populated here -->
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="performance-chart">
                <h5><i class="fas fa-tachometer-alt me-2"></i>System Resources</h5>
                <div class="row">
                    <div class="col-6">
                        <div class="metric-card text-center">
                            <div class="metric-value" id="cpu-usage">--</div>
                            <div class="metric-label">CPU Usage</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card text-center">
                            <div class="metric-value" id="memory-usage">--</div>
                            <div class="metric-label">Memory Usage</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="metric-card text-center">
                            <div class="metric-value" id="disk-usage">--</div>
                            <div class="metric-label">Disk Usage</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card text-center">
                            <div class="metric-value" id="uptime">--</div>
                            <div class="metric-label">Uptime</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="performance-chart">
                <h5><i class="fas fa-database me-2"></i>Service Performance</h5>
                <div class="row">
                    <div class="col-6">
                        <div class="metric-card text-center">
                            <div class="metric-value" id="db-performance">--</div>
                            <div class="metric-label">DB Response (ms)</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card text-center">
                            <div class="metric-value" id="redis-performance">--</div>
                            <div class="metric-label">Redis Response (ms)</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="metric-card text-center">
                            <div class="metric-value" id="availability">--</div>
                            <div class="metric-label">Availability %</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card text-center">
                            <div class="metric-value" id="error-rate">--</div>
                            <div class="metric-label">Error Rate %</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts and Notifications -->
    <div class="row mb-4">
        <div class="col-12">
            <h4><i class="fas fa-exclamation-triangle me-2"></i>Recent Alerts</h4>
            <div id="alerts-container">
                <!-- Alerts will be populated here -->
            </div>
        </div>
    </div>

    <!-- Monitoring Configuration -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="performance-chart">
                <h5><i class="fas fa-sliders-h me-2"></i>Monitoring Configuration</h5>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Metrics Interval (seconds)</label>
                        <input type="number" class="form-control" id="metrics-interval" value="30" min="10" max="300">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Alert Threshold (%)</label>
                        <input type="number" class="form-control" id="alert-threshold" value="80" min="50" max="100">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Check Interval (seconds)</label>
                        <input type="number" class="form-control" id="check-interval" value="30" min="10" max="300">
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="updateConfig()">
                        <i class="fas fa-save me-2"></i>Update Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Refresh Indicator -->
<div class="refresh-indicator" id="refresh-indicator">
    <i class="fas fa-sync-alt fa-spin me-2"></i>Refreshing...
</div>
{% endblock %}

{% block extra_js %}
<script>
let monitoringData = {};
let refreshInterval;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadMonitoringData();
    setupAutoRefresh();
});

function setupAutoRefresh() {
    // Refresh every 30 seconds
    refreshInterval = setInterval(loadMonitoringData, 30000);
}

function showRefreshIndicator() {
    document.getElementById('refresh-indicator').style.display = 'block';
}

function hideRefreshIndicator() {
    document.getElementById('refresh-indicator').style.display = 'none';
}

async function loadMonitoringData() {
    try {
        showRefreshIndicator();
        
        // Load monitoring dashboard data
        const response = await fetch('/api/monitoring/dashboard/');
        const data = await response.json();
        monitoringData = data;
        
        // Update UI
        updateServiceStatus(data);
        updatePerformanceMetrics(data);
        updateAlerts(data);
        updateLastUpdated();
        
    } catch (error) {
        console.error('Error loading monitoring data:', error);
        showError('Failed to load monitoring data');
    } finally {
        hideRefreshIndicator();
    }
}

function updateServiceStatus(data) {
    const serviceGrid = document.getElementById('service-grid');
    const services = data.application_monitoring?.service_status || {};
    
    let html = '';
    
    // Django Service
    html += createServiceCard('Django', 'fab fa-python', services.django || 'unknown');
    
    // Database Service
    html += createServiceCard('Database', 'fas fa-database', services.database || 'unknown');
    
    // Redis Service
    html += createServiceCard('Redis', 'fas fa-memory', services.redis || 'unknown');
    
    // Celery Service
    html += createServiceCard('Celery', 'fas fa-tasks', services.celery || 'unknown');
    
    // WebSocket Service
    html += createServiceCard('WebSocket', 'fas fa-wifi', services.websockets || 'unknown');
    
    // Monitoring Status
    const appMonitoring = data.application_monitoring?.monitoring_active || false;
    const uptimeMonitoring = data.uptime_monitoring?.monitoring_active || false;
    
    html += createServiceCard('App Monitoring', 'fas fa-chart-line', appMonitoring ? 'healthy' : 'unhealthy');
    html += createServiceCard('Uptime Monitoring', 'fas fa-clock', uptimeMonitoring ? 'healthy' : 'unhealthy');
    
    serviceGrid.innerHTML = html;
}

function createServiceCard(name, icon, status) {
    const statusClass = `status-${status}`;
    const statusText = status.charAt(0).toUpperCase() + status.slice(1);
    
    return `
        <div class="service-card">
            <div class="service-icon">
                <i class="${icon}"></i>
            </div>
            <h6>${name}</h6>
            <div class="status-indicator ${statusClass}"></div>
            <span class="text-muted">${statusText}</span>
        </div>
    `;
}

function updatePerformanceMetrics(data) {
    const performance = data.application_monitoring?.performance_summary || {};
    
    // System resources
    if (performance.cpu_usage) {
        document.getElementById('cpu-usage').textContent = `${performance.cpu_usage.current.toFixed(1)}%`;
    }
    if (performance.memory_usage) {
        document.getElementById('memory-usage').textContent = `${performance.memory_usage.current.toFixed(1)}%`;
    }
    if (performance.disk_usage) {
        document.getElementById('disk-usage').textContent = `${performance.disk_usage.current.toFixed(1)}%`;
    }
    
    // Service performance
    if (performance.database_performance) {
        document.getElementById('db-performance').textContent = `${performance.database_performance.current.toFixed(1)}`;
    }
    if (performance.redis_performance) {
        document.getElementById('redis-performance').textContent = `${performance.redis_performance.current.toFixed(1)}`;
    }
    
    // Uptime and availability
    const uptimeData = data.uptime_monitoring;
    if (uptimeData?.current_uptime?.formatted) {
        document.getElementById('uptime').textContent = uptimeData.current_uptime.formatted;
    }
    if (uptimeData?.availability_percentage) {
        document.getElementById('availability').textContent = `${uptimeData.availability_percentage.toFixed(1)}%`;
    }
    
    // Error rate
    const errorData = data.error_alerting;
    if (errorData?.error_counts) {
        const totalErrors = Object.values(errorData.error_counts).reduce((a, b) => a + b, 0);
        const errorRate = totalErrors > 0 ? (totalErrors / 100) * 100 : 0;
        document.getElementById('error-rate').textContent = `${errorRate.toFixed(1)}%`;
    }
}

function updateAlerts(data) {
    const alertsContainer = document.getElementById('alerts-container');
    const appAlerts = data.application_monitoring?.recent_alerts || [];
    const errorAlerts = data.error_alerting?.recent_alerts || [];
    
    let html = '';
    
    if (appAlerts.length === 0 && errorAlerts.length === 0) {
        html = '<div class="alert alert-success">No recent alerts</div>';
    } else {
        // Application alerts
        appAlerts.forEach(alert => {
            html += createAlertCard(alert, 'application');
        });
        
        // Error alerts
        errorAlerts.forEach(alert => {
            html += createAlertCard(alert, 'error');
        });
    }
    
    alertsContainer.innerHTML = html;
}

function createAlertCard(alert, type) {
    const severity = alert.severity || 'warning';
    const alertClass = severity === 'critical' ? 'alert-critical' : 'alert-warning';
    
    return `
        <div class="alert-card ${alertClass}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">${alert.type || 'Alert'}</h6>
                    <p class="mb-1">${alert.message || 'No message'}</p>
                    <small class="text-muted">${alert.timestamp || 'Unknown time'}</small>
                </div>
                <span class="badge bg-${severity === 'critical' ? 'danger' : 'warning'}">${severity.toUpperCase()}</span>
            </div>
        </div>
    `;
}

function updateLastUpdated() {
    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
}

async function startMonitoring() {
    try {
        const response = await fetch('/api/monitoring/start/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            showSuccess('Monitoring services started successfully');
            setTimeout(loadMonitoringData, 2000); // Reload data after 2 seconds
        } else {
            showError('Failed to start monitoring services');
        }
    } catch (error) {
        console.error('Error starting monitoring:', error);
        showError('Error starting monitoring services');
    }
}

async function stopMonitoring() {
    try {
        const response = await fetch('/api/monitoring/stop/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            showSuccess('Monitoring services stopped successfully');
            setTimeout(loadMonitoringData, 2000); // Reload data after 2 seconds
        } else {
            showError('Failed to stop monitoring services');
        }
    } catch (error) {
        console.error('Error stopping monitoring:', error);
        showError('Error stopping monitoring services');
    }
}

async function testAlert() {
    try {
        const response = await fetch('/api/monitoring/test-alert/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new FormData()
        });
        
        if (response.ok) {
            showSuccess('Test alert triggered successfully');
            setTimeout(loadMonitoringData, 2000); // Reload data after 2 seconds
        } else {
            showError('Failed to trigger test alert');
        }
    } catch (error) {
        console.error('Error triggering test alert:', error);
        showError('Error triggering test alert');
    }
}

async function updateConfig() {
    try {
        const config = {
            application_monitoring: {
                metrics_interval: parseInt(document.getElementById('metrics-interval').value),
                alert_threshold: parseInt(document.getElementById('alert-threshold').value)
            },
            uptime_monitoring: {
                check_interval: parseInt(document.getElementById('check-interval').value)
            }
        };
        
        const response = await fetch('/api/monitoring/config/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(config)
        });
        
        if (response.ok) {
            showSuccess('Configuration updated successfully');
        } else {
            showError('Failed to update configuration');
        }
    } catch (error) {
        console.error('Error updating configuration:', error);
        showError('Error updating configuration');
    }
}

function refreshData() {
    loadMonitoringData();
}

function showSuccess(message) {
    // You can implement a toast notification system here
    alert(message);
}

function showError(message) {
    // You can implement a toast notification system here
    alert('Error: ' + message);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
